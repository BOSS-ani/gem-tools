<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コンテンツ制作ツールハブ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto-Sans-JP', sans-serif;
            background-color: #111827;
            color: #F3F4F6;
        }
        .nav-button {
            background-color: #374151;
            color: #D1D5DB;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s;
            border: 2px solid transparent;
            cursor: pointer;
        }
        .nav-button:hover {
            background-color: #4B5563;
        }
        .nav-button.active {
            background-color: #1F2937;
            color: #4F46E5;
            border-color: #4F46E5;
        }
        .tool-container {
            display: none;
        }
        .tool-container.active {
            display: block;
        }
        .step-card {
            background-color: #1F2937;
            border: 1px solid #374151;
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .step-number {
            background-color: #4F46E5;
            color: white;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        .main-button {
            background-color: #4F46E5;
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .main-button:hover {
            background-color: #4338CA;
        }
        .main-button:disabled {
            background-color: #374151;
            cursor: not-allowed;
        }
        .form-input, textarea, select {
            background-color: #374151;
            border: 1px solid #4B5563;
            border-radius: 0.5rem;
            color: #F3F4F6;
            padding: 0.75rem;
            width: 100%;
        }
        .form-input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 2px #4F46E5;
        }
        .form-checkbox {
            background-color: #374151;
            border-color: #4B5563;
        }
        .form-checkbox:checked {
            background-color: #4F46E5;
        }
        .loader-container {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            gap: 1rem;
        }
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #4B5563;
            border-bottom-color: #F3F4F6;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        audio::-webkit-media-controls-panel { background-color: #374151; }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-volume-slider,
        audio::-webkit-media-controls-mute-button { filter: invert(1); }
        .copy-button {
            background-color: #374151;
            border: 1px solid #4B5563;
            color: #D1D5DB;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .copy-button:hover {
            background-color: #4B5563;
        }
        /* Styles for Audio Splitter */
        .splitter-card {
            background-color: #1F2937;
            border-radius: 1rem;
            border: 1px solid #374151;
            padding: 1rem;
            transition: transform 0.2s;
        }
        .splitter-card:hover {
            transform: translateY(-4px);
        }
        .splitter-img {
             aspect-ratio: 16/9;
             object-fit: cover;
             background-color: #111827;
             border-radius: 0.5rem;
         }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">
                コンテンツ制作ツールハブ
            </h1>
            <p class="text-gray-400 mt-2">AIを活用したツールで制作ワークフローを加速させます。</p>
        </header>

        <!-- Navigation -->
        <nav class="flex flex-wrap justify-center gap-4 mb-10">
            <button id="nav-narration" class="nav-button" data-tool="narration">AIナレーション</button>
            <button id="nav-splitter" class="nav-button" data-tool="splitter">音声分割</button>
            <button id="nav-prompt" class="nav-button" data-tool="prompt">プロンプト生成</button>
            <button id="nav-content" class="nav-button" data-tool="content">コンテンツ生成</button>
            <button id="nav-youtube" class="nav-button" data-tool="youtube">YouTube概要欄</button>
        </nav>
        
        <div id="tool-contents">
            <!-- Tool: AI Narration Assistant -->
            <div id="narration-tool" class="tool-container">
                <!-- ... existing narration tool code ... -->
            </div>
            
            <!-- Tool: Audio Splitter -->
            <div id="splitter-tool" class="tool-container">
                <h2 class="text-2xl font-bold text-center mb-6">汎用・音声分割ダウンロードツール</h2>
                <div class="step-card">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <div class="flex items-start gap-4">
                                <div class="step-number">1</div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2">分割数を設定</h3>
                                    <p class="text-gray-400 mb-4">音声をいくつのパートに分けるか入力してください。</p>
                                    <div class="flex items-center gap-4">
                                        <input type="number" id="segment-count" min="1" value="8" placeholder="例: 8" class="form-input w-24 text-center">
                                        <button id="generate-segments-btn" class="main-button">セクションを生成</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-start gap-4">
                                <div class="step-number">2</div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2">音声ファイルをアップロード</h3>
                                    <p class="text-gray-400 mb-4">分割したいMP3ファイルをアップロードしてください。</p>
                                    <input type="file" id="audio-file-input" accept="audio/mp3" class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 transition cursor-pointer">
                                    <span id="splitter-file-status" class="text-green-400 font-semibold mt-2 block"></span>
                                    <p class="text-xs text-gray-500 mt-2">※ファイルはサーバーにアップロードされません。</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div id="segments-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mt-8">
                    <!-- Segments will be dynamically inserted here -->
                </div>
            </div>

            <!-- Tool: Prompt Generator -->
            <div id="prompt-tool" class="tool-container">
                <!-- ... existing prompt tool code ... -->
            </div>

            <!-- Tool: Content Generator -->
            <div id="content-tool" class="tool-container">
                 <!-- ... existing content generator tool code ... -->
            </div>

            <!-- Tool: YouTube Description Generator -->
            <div id="youtube-tool" class="tool-container">
                 <!-- ... existing youtube tool code ... -->
            </div>
        </div>
    </div>

     <div id="loader-container" class="loader-container hidden">
        <div class="loader"></div>
        <p id="loader-text" class="text-lg font-semibold">処理中...</p>
    </div>
    
    <!-- lamejs for MP3 encoding -->
    <script src="https://cdn.jsdelivr.net/npm/lamejs@1.2.1/lame.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Common Elements & Functions ---
        const loaderContainer = document.getElementById('loader-container');
        const loaderText = document.getElementById('loader-text');
        const showLoader = (text = '処理中...') => {
            loaderText.textContent = text;
            loaderContainer.classList.remove('hidden');
        };
        const hideLoader = () => { loaderContainer.classList.add('hidden'); };

        const handleRouting = () => {
            document.querySelectorAll('.tool-container').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-button').forEach(el => el.classList.remove('active'));
            const hash = window.location.hash.slice(1);
            let tool = new URLSearchParams(hash).get('tool');
            const validTools = ['narration', 'splitter', 'prompt', 'content', 'youtube'];
            if (!validTools.includes(tool)) { tool = 'narration'; }
            const targetToolEl = document.getElementById(`${tool}-tool`);
            const targetNavEl = document.getElementById(`nav-${tool}`);
            if (targetToolEl && targetNavEl) {
                targetToolEl.classList.add('active');
                targetNavEl.classList.add('active');
            }
        };
        document.querySelectorAll('.nav-button').forEach(button => {
            button.addEventListener('click', () => { window.location.hash = `tool=${button.dataset.tool}`; });
        });
        window.addEventListener('hashchange', handleRouting);
        handleRouting(); // Initial load

        // --- Generic Copy Function ---
        const setupCopyButton = (button, feedbackEl) => {
            button.addEventListener('click', () => {
                const targetId = button.dataset.target;
                const targetTextarea = document.getElementById(targetId);
                targetTextarea.select();
                try {
                    document.execCommand('copy');
                    if (feedbackEl) {
                        feedbackEl.classList.remove('opacity-0');
                        setTimeout(() => { feedbackEl.classList.add('opacity-0'); }, 2000);
                    }
                } catch (err) {
                    alert('コピーに失敗しました。');
                }
            });
        };
        
        // --- AI Narration Assistant ---
        // ... existing narration assistant script ...
        
        // --- Audio Splitter ---
        const splitterAudioFileInput = document.getElementById('audio-file-input');
        const segmentsContainer = document.getElementById('segments-container');
        const splitterFileStatus = document.getElementById('splitter-file-status');
        const segmentCountInput = document.getElementById('segment-count');
        const generateSegmentsBtn = document.getElementById('generate-segments-btn');
        let splitterAudioBuffer = null;
        let splitterAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        const generateSegmentCards = () => {
            const count = parseInt(segmentCountInput.value);
            if (isNaN(count) || count < 1) {
                alert('有効な分割数を入力してください。');
                return;
            }
            segmentsContainer.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const segmentId = i + 1;
                const card = document.createElement('div');
                card.className = 'splitter-card flex flex-col gap-3';
                const title = `パート ${segmentId}`;
                card.innerHTML = `
                    <img src="https://placehold.co/1600x900/111827/F3F4F6?text=Part+${segmentId}" alt="${title}" class="splitter-img">
                    <h3 class="text-lg font-bold text-center">${title}</h3>
                    <div class="flex items-center justify-center gap-2">
                        <input type="number" id="start-${segmentId}" min="0" placeholder="開始(秒)" class="form-input w-24 text-center text-sm p-1">
                        <span>-</span>
                        <input type="number" id="end-${segmentId}" min="0" placeholder="終了(秒)" class="form-input w-24 text-center text-sm p-1">
                    </div>
                    <button data-id="${segmentId}" class="download-btn main-button w-full justify-center text-sm" disabled>ダウンロード</button>
                `;
                segmentsContainer.appendChild(card);
            }
            if(splitterAudioBuffer) {
                autoFillTimes();
                document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = false);
            }
        };
        
        generateSegmentsBtn.addEventListener('click', generateSegmentCards);
        
        const autoFillTimes = () => {
            const duration = splitterAudioBuffer.duration;
            const segmentCount = segmentsContainer.children.length;
            if (segmentCount === 0) return;
            const segmentDuration = duration / segmentCount;
            for(let i=0; i<segmentCount; i++){
                const segmentId = i + 1;
                const startTimeInput = document.getElementById(`start-${segmentId}`);
                const endTimeInput = document.getElementById(`end-${segmentId}`);
                const startTime = (segmentDuration * i).toFixed(1);
                let endTime = (segmentDuration * (i + 1)).toFixed(1);
                if (i === segmentCount - 1) { endTime = duration.toFixed(1); }
                startTimeInput.value = startTime;
                endTimeInput.value = endTime;
            }
        };
        
        splitterAudioFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (segmentsContainer.children.length === 0) {
                alert('先に分割数を設定し、「セクションを生成」ボタンを押してください。');
                splitterAudioFileInput.value = '';
                return;
            }
            showLoader('音声データを処理中...');
            splitterFileStatus.textContent = '';
            document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = true);
            try {
                const arrayBuffer = await file.arrayBuffer();
                splitterAudioBuffer = await splitterAudioContext.decodeAudioData(arrayBuffer);
                splitterFileStatus.textContent = `✅ ${file.name} が読み込まれました。`;
                document.querySelectorAll('.download-btn').forEach(btn => btn.disabled = false);
                autoFillTimes();
            } catch (error) {
                console.error('Error decoding audio data:', error);
                splitterFileStatus.textContent = '❌ 音声ファイルの読み込みに失敗しました。';
            } finally {
                hideLoader();
            }
        });
        
        segmentsContainer.addEventListener('click', async (event) => {
            if (event.target.classList.contains('download-btn')) {
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = '処理中...';
                const segmentId = button.dataset.id;
                try {
                    await handleDownload(segmentId);
                } catch (e) {
                    console.error("Download failed", e);
                    alert("ダウンロードに失敗しました: " + e.message);
                } finally {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        });

        function handleDownload(segmentId) {
            return new Promise((resolve, reject) => {
                if (!splitterAudioBuffer) {
                    return reject(new Error('先に音声ファイルをアップロードしてください。'));
                }
                const startTime = parseFloat(document.getElementById(`start-${segmentId}`).value);
                const endTime = parseFloat(document.getElementById(`end-${segmentId}`).value);
                if (isNaN(startTime) || isNaN(endTime) || startTime < 0 || endTime <= startTime) {
                    return reject(new Error('有効な開始時間と終了時間を入力してください。'));
                }
                const startOffset = Math.floor(startTime * splitterAudioBuffer.sampleRate);
                const endOffset = Math.floor(endTime * splitterAudioBuffer.sampleRate);
                const frameCount = endOffset - startOffset;
                if (frameCount <= 0) {
                    return reject(new Error('終了時間は開始時間より大きくする必要があります。'));
                }
                const newBuffer = splitterAudioContext.createBuffer(
                    splitterAudioBuffer.numberOfChannels,
                    frameCount,
                    splitterAudioBuffer.sampleRate
                );
                for (let i = 0; i < splitterAudioBuffer.numberOfChannels; i++) {
                    const channelData = splitterAudioBuffer.getChannelData(i);
                    const newChannelData = newBuffer.getChannelData(i);
                    newChannelData.set(channelData.subarray(startOffset, endOffset));
                }
                const mp3Data = encodeToMp3(newBuffer);
                const blob = new Blob(mp3Data, { type: 'audio/mp3' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `Part_${segmentId}.mp3`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                resolve();
            });
        }
        
        function encodeToMp3(audioBuffer) {
            const numberOfChannels = audioBuffer.numberOfChannels;
            const mp3encoder = new lamejs.Mp3Encoder(numberOfChannels, audioBuffer.sampleRate, 128);
            const mp3Data = [];
            const samples = new Int16Array(audioBuffer.getChannelData(0).length);
            floatTo16BitPCM(audioBuffer.getChannelData(0), samples);
            let remaining = samples.length;
            const bufferSize = 1152;
             if (numberOfChannels === 2) {
                const right = new Int16Array(audioBuffer.getChannelData(1).length);
                floatTo16BitPCM(audioBuffer.getChannelData(1), right);
                 for (let i = 0; remaining >= bufferSize; i += bufferSize) {
                    const leftChunk = samples.subarray(i, i + bufferSize);
                    const rightChunk = right.subarray(i, i + bufferSize);
                    const mp3buf = mp3encoder.encodeBuffer(leftChunk, rightChunk);
                    if (mp3buf.length > 0) mp3Data.push(mp3buf);
                    remaining -= bufferSize;
                }
            } else {
                for (let i = 0; remaining >= bufferSize; i += bufferSize) {
                    const chunk = samples.subarray(i, i + bufferSize);
                    const mp3buf = mp3encoder.encodeBuffer(chunk);
                    if (mp3buf.length > 0) mp3Data.push(mp3buf);
                    remaining -= bufferSize;
                }
            }
            const flushed = mp3encoder.flush();
            if (flushed.length > 0) mp3Data.push(flushed);
            return mp3Data;
        }

        function floatTo16BitPCM(input, output) {
            for (let i = 0; i < input.length; i++) {
                const s = Math.max(-1, Math.min(1, input[i]));
                output[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
        }
        
        // --- NotebookLM Prompt Generator ---
        // ... existing prompt generator script ...

        // --- Content Generator ---
        // ... existing content generator script ...
        
        // --- YouTube Description Generator ---
        // ... existing youtube generator script ...

        // --- Common Gemini API Call Function ---
        // ... existing gemini api call script ...

        // --- Audio Helper Functions for Narration ---
        // ... existing audio helper script for narration ...
        
        // Initial call to generate default splitter cards
        generateSegmentCards();
    });
</script>
</body>
</html>

